@{
    Layout = "_Layout";
    ViewData["Title"] = "Quản lý hóa đơn";
}

<div class="d-flex justify-content-between mb-4">
    <h2><i class="fas fa-receipt"></i> Hóa đơn</h2>
    <a asp-action="CreateHoaDon" class="btn btn-success">
        <i class="fas fa-plus"></i> Tạo hóa đơn
    </a>
</div>

<div id="alertContainer"></div>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="fas fa-check-circle"></i> @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-triangle"></i> @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped" id="hoaDonTable">
                <thead>
                    <tr>
                        <th>Mã</th>
                        <th>Hợp đồng</th>
                        <th>Khách hàng</th>
                        <th>Ngày lập</th>
                        <th>Số tiền</th>
                        <th>Loại thanh toán</th>
                        <th>Nhân viên</th>
                    </tr>
                </thead>
                <tbody id="hoaDonTableBody">
                    <tr>
                        <td colspan="7" class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Đang tải...</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<a asp-action="Index" class="btn btn-secondary">
    <i class="fas fa-arrow-left"></i> Quay lại
</a>

@section Scripts {
    <script>
        const API_BASE = window.location.origin;

        function showAlert(message, type = 'success') {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            document.getElementById('alertContainer').innerHTML = alertHtml;
            setTimeout(() => {
                document.querySelector('#alertContainer .alert')?.remove();
            }, 5000);
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN').format(amount);
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN');
        }

        async function loadHoaDons() {
            try {
                const response = await fetch(`${API_BASE}/api/HoaDonApi`, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        showAlert('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.', 'danger');
                        return;
                    }
                    if (response.status === 403) {
                        showAlert('Bạn không có quyền truy cập chức năng này.', 'danger');
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                if (result.success) {
                    const tbody = document.getElementById('hoaDonTableBody');
                    if (result.data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" class="text-center">Chưa có hóa đơn nào</td></tr>';
                    } else {
                        tbody.innerHTML = result.data.map(item => `
                            <tr>
                                <td><strong>#${item.maHoaDon}</strong></td>
                                <td>
                                    <span class="badge bg-primary">
                                        <i class="fas fa-file-contract"></i> #${item.hopDong?.maHopDong || 'N/A'}
                                    </span>
                                </td>
                                <td>${item.hopDong?.khachHang?.hoTen || 'N/A'}</td>
                                <td>${formatDate(item.ngayLap)}</td>
                                <td><strong class="text-success">${formatCurrency(item.soTienThanhToan)} VNĐ</strong></td>
                                <td>
                                    <span class="badge bg-info">${item.loaiThanhToan || ''}</span>
                                </td>
                                <td>
                                    <small class="text-muted">
                                        <i class="fas fa-user"></i> ${item.nhanVien?.hoTen || 'N/A'}
                                    </small>
                                </td>
                            </tr>
                        `).join('');
                    }
                } else {
                    showAlert(result.message || 'Có lỗi xảy ra', 'danger');
                }
            } catch (error) {
                showAlert('Lỗi kết nối đến server: ' + (error.message || 'Không thể tải dữ liệu'), 'danger');
                console.error('Error details:', error);
            }
        }

        // Load danh sách khi trang được tải
        window.onload = function() {
            loadHoaDons();
        };
    </script>
}