@{
    Layout = "_Layout";
    ViewData["Title"] = "Quản lý tài khoản kế toán";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-users"></i> Quản lý tài khoản kế toán</h2>
    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createModal">
        <i class="fas fa-plus"></i> Tạo tài khoản mới
    </button>
</div>

<div id="alertContainer"></div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="accountantsTable">
                <thead>
                    <tr>
                        <th>Mã NV</th>
                        <th>Tên đăng nhập</th>
                        <th>Họ tên</th>
                        <th>Quyền</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody id="accountantsTableBody">
                    <tr>
                        <td colspan="5" class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Đang tải...</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal Tạo mới -->
<div class="modal fade" id="createModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-user-plus"></i> Tạo tài khoản kế toán</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="createForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Tên đăng nhập *</label>
                        <input type="text" class="form-control" id="createTenDangNhap" required />
                        <div class="invalid-feedback"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Họ và tên *</label>
                        <input type="text" class="form-control" id="createHoTen" required />
                        <div class="invalid-feedback"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Mật khẩu *</label>
                        <input type="password" class="form-control" id="createMatKhau" required />
                        <div class="invalid-feedback"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Xác nhận mật khẩu *</label>
                        <input type="password" class="form-control" id="createConfirmMatKhau" required />
                        <div class="invalid-feedback"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-success">Tạo tài khoản</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Sửa -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title"><i class="fas fa-edit"></i> Sửa tài khoản</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editForm">
                <input type="hidden" id="editId" />
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Tên đăng nhập *</label>
                        <input type="text" class="form-control" id="editTenDangNhap" required />
                        <div class="invalid-feedback"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Họ và tên *</label>
                        <input type="text" class="form-control" id="editHoTen" required />
                        <div class="invalid-feedback"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Mật khẩu mới (để trống nếu không đổi)</label>
                        <input type="password" class="form-control" id="editMatKhau" />
                        <div class="invalid-feedback"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Xác nhận mật khẩu mới</label>
                        <input type="password" class="form-control" id="editConfirmMatKhau" />
                        <div class="invalid-feedback"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-warning">Cập nhật</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="mt-3">
    <a asp-controller="Admin" asp-action="Index" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Quay lại
    </a>
</div>

@section Scripts {
    <script>
        const API_BASE = window.location.origin;

        function showAlert(message, type = 'success') {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            document.getElementById('alertContainer').innerHTML = alertHtml;
            setTimeout(() => {
                document.querySelector('#alertContainer .alert')?.remove();
            }, 5000);
        }

        async function loadAccountants() {
            try {
                const response = await fetch(`${API_BASE}/api/AdminApi/accountants`, {
                    credentials: 'include'
                });
                const result = await response.json();

                if (result.success) {
                    const tbody = document.getElementById('accountantsTableBody');
                    if (result.data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="text-center">Chưa có tài khoản kế toán nào</td></tr>';
                    } else {
                        tbody.innerHTML = result.data.map(item => `
                            <tr>
                                <td>${item.maNhanVien}</td>
                                <td>${item.tenDangNhap}</td>
                                <td>${item.hoTen}</td>
                                <td><span class="badge bg-info">${item.quyen}</span></td>
                                <td>
                                    <button class="btn btn-sm btn-warning" onclick="editAccountant(${item.maNhanVien})">
                                        <i class="fas fa-edit"></i> Sửa
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteAccountant(${item.maNhanVien})">
                                        <i class="fas fa-trash"></i> Xóa
                                    </button>
                                </td>
                            </tr>
                        `).join('');
                    }
                } else {
                    showAlert(result.message || 'Có lỗi xảy ra', 'danger');
                }
            } catch (error) {
                showAlert('Lỗi kết nối đến server', 'danger');
                console.error(error);
            }
        }

        async function editAccountant(id) {
            try {
                const response = await fetch(`${API_BASE}/api/AdminApi/accountants/${id}`, {
                    credentials: 'include'
                });
                const result = await response.json();

                if (result.success) {
                    document.getElementById('editId').value = result.data.maNhanVien;
                    document.getElementById('editTenDangNhap').value = result.data.tenDangNhap;
                    document.getElementById('editHoTen').value = result.data.hoTen;
                    document.getElementById('editMatKhau').value = '';
                    document.getElementById('editConfirmMatKhau').value = '';
                    new bootstrap.Modal(document.getElementById('editModal')).show();
                } else {
                    showAlert(result.message || 'Không tìm thấy tài khoản', 'danger');
                }
            } catch (error) {
                showAlert('Lỗi kết nối đến server', 'danger');
                console.error(error);
            }
        }

        async function deleteAccountant(id) {
            if (!confirm('Bạn có chắc muốn xóa tài khoản này?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/AdminApi/accountants/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                const result = await response.json();

                if (result.success) {
                    showAlert(result.message || 'Xóa tài khoản thành công!');
                    loadAccountants();
                } else {
                    showAlert(result.message || 'Có lỗi xảy ra khi xóa', 'danger');
                }
            } catch (error) {
                showAlert('Lỗi kết nối đến server', 'danger');
                console.error(error);
            }
        }

        document.getElementById('createForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const tenDangNhap = document.getElementById('createTenDangNhap').value;
            const hoTen = document.getElementById('createHoTen').value;
            const matKhau = document.getElementById('createMatKhau').value;
            const confirmMatKhau = document.getElementById('createConfirmMatKhau').value;

            if (matKhau !== confirmMatKhau) {
                showAlert('Mật khẩu xác nhận không khớp', 'danger');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/AdminApi/accountants`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        tenDangNhap: tenDangNhap,
                        hoTen: hoTen,
                        matKhau: matKhau,
                        confirmMatKhau: confirmMatKhau
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showAlert(result.message || 'Tạo tài khoản thành công!');
                    bootstrap.Modal.getInstance(document.getElementById('createModal')).hide();
                    document.getElementById('createForm').reset();
                    loadAccountants();
                } else {
                    showAlert(result.message || 'Có lỗi xảy ra', 'danger');
                }
            } catch (error) {
                showAlert('Lỗi kết nối đến server', 'danger');
                console.error(error);
            }
        });

        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('editId').value;
            const tenDangNhap = document.getElementById('editTenDangNhap').value;
            const hoTen = document.getElementById('editHoTen').value;
            const matKhau = document.getElementById('editMatKhau').value;
            const confirmMatKhau = document.getElementById('editConfirmMatKhau').value;

            if (matKhau && matKhau !== confirmMatKhau) {
                showAlert('Mật khẩu xác nhận không khớp', 'danger');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/AdminApi/accountants/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        tenDangNhap: tenDangNhap,
                        hoTen: hoTen,
                        matKhau: matKhau || '',
                        confirmMatKhau: confirmMatKhau || ''
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showAlert(result.message || 'Cập nhật tài khoản thành công!');
                    bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
                    document.getElementById('editForm').reset();
                    loadAccountants();
                } else {
                    showAlert(result.message || 'Có lỗi xảy ra', 'danger');
                }
            } catch (error) {
                showAlert('Lỗi kết nối đến server', 'danger');
                console.error(error);
            }
        });

        // Load danh sách khi trang được tải
        window.onload = function() {
            loadAccountants();
        };
    </script>
}