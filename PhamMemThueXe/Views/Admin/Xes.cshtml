@{
    Layout = "_Layout";
    ViewData["Title"] = "Quản lý xe";
}

<style>
    .xe-card {
        transition: transform 0.2s, box-shadow 0.2s;
        border-radius: 10px;
        border-left: 4px solid;
    }
    .xe-card.status-ready {
        border-left-color: #28a745;
    }
    .xe-card.status-renting {
        border-left-color: #ffc107;
    }
    .xe-card.status-maintenance {
        border-left-color: #dc3545;
    }
    .xe-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }
    .status-badge {
        font-size: 0.85rem;
        padding: 0.4em 0.8em;
    }
    .bien-so-badge {
        font-family: 'Courier New', monospace;
        font-size: 1rem;
        font-weight: bold;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    .filter-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1.5rem;
    }
    .table-hover tbody tr {
        cursor: pointer;
    }
</style>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-car"></i> Quản lý xe</h2>
    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createModal">
        <i class="fas fa-plus"></i> Thêm xe mới
    </button>
</div>

<div id="alertContainer"></div>

<!-- Filter Section -->
<div class="filter-section">
    <div class="row g-3 align-items-end">
        <div class="col-md-4">
            <label class="form-label fw-bold">Lọc theo loại xe:</label>
            <select class="form-select" id="filterLoaiXe">
                <option value="">Tất cả loại xe</option>
            </select>
        </div>
        <div class="col-md-4">
            <label class="form-label fw-bold">Lọc theo trạng thái:</label>
            <select class="form-select" id="filterTrangThai">
                <option value="">Tất cả trạng thái</option>
                <option value="Sẵn sàng">Sẵn sàng</option>
                <option value="Đang cho thuê">Đang cho thuê</option>
                <option value="Bảo trì">Bảo trì</option>
            </select>
        </div>
        <div class="col-md-4">
            <button type="button" class="btn btn-outline-secondary w-100" onclick="resetFilters()">
                <i class="fas fa-redo"></i> Đặt lại
            </button>
        </div>
    </div>
</div>

<!-- Table View -->
<div class="card shadow-sm">
    <div class="card-header bg-info text-white">
        <h5 class="mb-0"><i class="fas fa-list"></i> Danh sách xe</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="xeTable">
                <thead class="table-dark">
                    <tr>
                        <th style="width: 80px;">Hình ảnh</th>
                        <th>Mã xe</th>
                        <th>Biển số xe</th>
                        <th>Tên xe</th>
                        <th>Loại xe</th>
                        <th>Trạng thái</th>
                        <th class="text-end">Thao tác</th>
                    </tr>
                </thead>
                <tbody id="xeTableBody">
                    <tr>
                        <td colspan="6" class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Đang tải...</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal Tạo mới -->
<div class="modal fade" id="createModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-plus-circle"></i> Thêm xe mới</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="createForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Biển số xe <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="createBienSoXe" required 
                               placeholder="Ví dụ: 30A-12345" style="text-transform: uppercase;" />
                        <div class="invalid-feedback"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Tên xe <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="createTenXe" required 
                               placeholder="Ví dụ: Toyota Camry 2023" />
                        <div class="invalid-feedback"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Loại xe <span class="text-danger">*</span></label>
                        <select class="form-select" id="createMaLoaiXe" required>
                            <option value="">-- Chọn loại xe --</option>
                        </select>
                        <div class="invalid-feedback"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Trạng thái <span class="text-danger">*</span></label>
                        <select class="form-select" id="createTrangThai" required>
                            <option value="Sẵn sàng" selected>Sẵn sàng</option>
                            <option value="Đang cho thuê">Đang cho thuê</option>
                            <option value="Bảo trì">Bảo trì</option>
                        </select>
                        <div class="invalid-feedback"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">URL Hình ảnh</label>
                        <input type="url" class="form-control" id="createImageURL" 
                               placeholder="Ví dụ: https://example.com/images/car.jpg" />
                        <small class="form-text text-muted">Nhập đường dẫn URL đến hình ảnh xe (tùy chọn)</small>
                        <div id="createImagePreview" class="mt-2" style="display: none;">
                            <img id="createPreviewImg" src="" alt="Preview" class="img-thumbnail" style="max-width: 200px; max-height: 150px;" onerror="this.style.display='none'; this.parentElement.style.display='none';">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Hủy
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-check"></i> Thêm xe
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Sửa -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title"><i class="fas fa-edit"></i> Chỉnh sửa xe</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editForm">
                <input type="hidden" id="editId" />
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Biển số xe <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="editBienSoXe" required 
                               style="text-transform: uppercase;" />
                        <div class="invalid-feedback"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Tên xe <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="editTenXe" required />
                        <div class="invalid-feedback"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Loại xe <span class="text-danger">*</span></label>
                        <select class="form-select" id="editMaLoaiXe" required>
                            <option value="">-- Chọn loại xe --</option>
                        </select>
                        <div class="invalid-feedback"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Trạng thái <span class="text-danger">*</span></label>
                        <select class="form-select" id="editTrangThai" required>
                            <option value="Sẵn sàng">Sẵn sàng</option>
                            <option value="Đang cho thuê">Đang cho thuê</option>
                            <option value="Bảo trì">Bảo trì</option>
                        </select>
                        <div class="invalid-feedback"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">URL Hình ảnh</label>
                        <input type="url" class="form-control" id="editImageURL" 
                               placeholder="Ví dụ: https://example.com/images/car.jpg" />
                        <small class="form-text text-muted">Nhập đường dẫn URL đến hình ảnh xe (tùy chọn)</small>
                        <div id="editImagePreview" class="mt-2" style="display: none;">
                            <img id="editPreviewImg" src="" alt="Preview" class="img-thumbnail" style="max-width: 200px; max-height: 150px;" onerror="this.style.display='none'; this.parentElement.style.display='none';">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Hủy
                    </button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-save"></i> Cập nhật
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="mt-4">
    <a asp-controller="Admin" asp-action="Index" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Quay lại
    </a>
</div>

@section Scripts {
    <script>
        const API_BASE = window.location.origin;
        let allXes = [];
        let loaiXes = [];

        function showAlert(message, type = 'success') {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i> ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            document.getElementById('alertContainer').innerHTML = alertHtml;
            setTimeout(() => {
                const alert = document.querySelector('#alertContainer .alert');
                if (alert) alert.remove();
            }, 5000);
        }

        function getStatusBadge(trangThai) {
            const badges = {
                'Sẵn sàng': '<span class="badge bg-success status-badge">Sẵn sàng</span>',
                'Đang cho thuê': '<span class="badge bg-warning text-dark status-badge">Đang cho thuê</span>',
                'Bảo trì': '<span class="badge bg-danger status-badge">Bảo trì</span>'
            };
            return badges[trangThai] || '<span class="badge bg-secondary status-badge">' + trangThai + '</span>';
        }

        async function loadLoaiXes() {
            try {
                const response = await fetch(`${API_BASE}/api/LoaiXeApi`, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();

                if (result.success) {
                    loaiXes = result.data;
                    const options = loaiXes.map(lx => 
                        `<option value="${lx.maLoaiXe}">${lx.tenLoaiXe}</option>`
                    ).join('');
                    
                    document.getElementById('createMaLoaiXe').innerHTML = 
                        '<option value="">-- Chọn loại xe --</option>' + options;
                    document.getElementById('editMaLoaiXe').innerHTML = 
                        '<option value="">-- Chọn loại xe --</option>' + options;
                    document.getElementById('filterLoaiXe').innerHTML = 
                        '<option value="">Tất cả loại xe</option>' + options;
                }
            } catch (error) {
                console.error('Error loading loai xe:', error);
                showAlert('Không thể tải danh sách loại xe. Vui lòng thử lại.', 'warning');
            }
        }

        async function loadXes() {
            try {
                const response = await fetch(`${API_BASE}/api/XeApi`, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        showAlert('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.', 'danger');
                        return;
                    }
                    if (response.status === 403) {
                        showAlert('Bạn không có quyền truy cập chức năng này.', 'danger');
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const contentType = response.headers.get("content-type");
                if (!contentType || !contentType.includes("application/json")) {
                    const text = await response.text();
                    console.error('Response is not JSON:', text);
                    showAlert('Phản hồi từ server không đúng định dạng. Vui lòng thử lại.', 'danger');
                    return;
                }
                
                const result = await response.json();

                if (result.success) {
                    allXes = result.data;
                    filterAndDisplayXes();
                } else {
                    showAlert(result.message || 'Có lỗi xảy ra', 'danger');
                }
            } catch (error) {
                console.error('Error loading xes:', error);
                showAlert(`Lỗi kết nối đến server: ${error.message}`, 'danger');
            }
        }

        function filterAndDisplayXes() {
            const filterLoaiXe = document.getElementById('filterLoaiXe').value;
            const filterTrangThai = document.getElementById('filterTrangThai').value;

            let filteredXes = allXes;
            
            if (filterLoaiXe) {
                filteredXes = filteredXes.filter(x => x.loaiXe && x.loaiXe.maLoaiXe == filterLoaiXe);
            }
            
            if (filterTrangThai) {
                filteredXes = filteredXes.filter(x => x.trangThai === filterTrangThai);
            }

            const tbody = document.getElementById('xeTableBody');
            if (filteredXes.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">
                            <i class="fas fa-car fa-2x mb-2"></i>
                            <p class="mb-0">Không có xe nào phù hợp với bộ lọc</p>
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = filteredXes.map(item => `
                    <tr>
                        <td>
                            ${item.imageURL ? 
                                `<img src="${item.imageURL}" alt="${item.tenXe || ''}" class="img-thumbnail" style="width: 60px; height: 45px; object-fit: cover;" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'60\' height=\'45\'%3E%3Crect fill=\'%23ddd\' width=\'60\' height=\'45\'/%3E%3Ctext fill=\'%23999\' font-family=\'Arial\' font-size=\'12\' x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dominant-baseline=\'middle\'%3ENo Image%3C/text%3E%3C/svg%3E'; this.onerror=null;">` :
                                `<div class="bg-light d-flex align-items-center justify-content-center" style="width: 60px; height: 45px; border: 1px solid #ddd; border-radius: 4px;">
                                    <i class="fas fa-image text-muted"></i>
                                </div>`
                            }
                        </td>
                        <td><strong>#${item.maXe}</strong></td>
                        <td>
                            <span class="badge bien-so-badge">${item.bienSoXe || ''}</span>
                        </td>
                        <td>
                            <i class="fas fa-car text-primary me-2"></i>
                            <strong>${item.tenXe || ''}</strong>
                        </td>
                        <td>
                            ${item.loaiXe ? 
                                `<span class="badge bg-info"><i class="fas fa-car-side"></i> ${item.loaiXe.tenLoaiXe || 'N/A'}</span>` :
                                '<span class="badge bg-secondary">Chưa phân loại</span>'
                            }
                        </td>
                        <td>${getStatusBadge(item.trangThai)}</td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-warning me-1" onclick="editXe(${item.maXe})" title="Sửa">
                                <i class="fas fa-edit"></i> Sửa
                            </button>
                            <button class="btn btn-sm btn-danger me-1" onclick="deleteXe(${item.maXe}, '${(item.bienSoXe || '').replace(/'/g, "\\'")}')" title="Xóa">
                                <i class="fas fa-trash"></i> Xóa
                            </button>
                            <button class="btn btn-sm btn-info" onclick="quickUpdateStatus(${item.maXe}, '${item.trangThai}')" title="Đổi trạng thái">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            }
        }

        function resetFilters() {
            document.getElementById('filterLoaiXe').value = '';
            document.getElementById('filterTrangThai').value = '';
            filterAndDisplayXes();
        }

        async function editXe(id) {
            try {
                const response = await fetch(`${API_BASE}/api/XeApi/${id}`, {
                    credentials: 'include'
                });
                const result = await response.json();

                if (result.success) {
                    document.getElementById('editId').value = result.data.maXe;
                    document.getElementById('editBienSoXe').value = result.data.bienSoXe || '';
                    document.getElementById('editTenXe').value = result.data.tenXe || '';
                    // Ưu tiên lấy từ maLoaiXe trực tiếp, nếu không có thì lấy từ loaiXe navigation
                    const maLoaiXe = result.data.maLoaiXe || result.data.loaiXe?.maLoaiXe || '';
                    document.getElementById('editMaLoaiXe').value = maLoaiXe;
                    document.getElementById('editTrangThai').value = result.data.trangThai || 'Sẵn sàng';
                    const imageURL = result.data.imageURL || '';
                    document.getElementById('editImageURL').value = imageURL;
                    // Hiển thị preview ngay nếu có URL
                    if (imageURL) {
                        const previewImg = document.getElementById('editPreviewImg');
                        previewImg.src = imageURL;
                        document.getElementById('editImagePreview').style.display = 'block';
                    } else {
                        document.getElementById('editImagePreview').style.display = 'none';
                    }
                    new bootstrap.Modal(document.getElementById('editModal')).show();
                } else {
                    showAlert(result.message || 'Không tìm thấy xe', 'danger');
                }
            } catch (error) {
                showAlert('Lỗi kết nối đến server', 'danger');
                console.error(error);
            }
        }

        async function quickUpdateStatus(id, currentStatus) {
            const statuses = ['Sẵn sàng', 'Đang cho thuê', 'Bảo trì'];
            const currentIndex = statuses.indexOf(currentStatus);
            const nextStatus = statuses[(currentIndex + 1) % statuses.length];

            if (!confirm(`Bạn có muốn đổi trạng thái sang "${nextStatus}"?`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/XeApi/${id}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        trangThai: nextStatus
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showAlert(result.message || 'Cập nhật trạng thái thành công!');
                    loadXes();
                } else {
                    showAlert(result.message || 'Có lỗi xảy ra', 'danger');
                }
            } catch (error) {
                showAlert('Lỗi kết nối đến server', 'danger');
                console.error(error);
            }
        }

        async function deleteXe(id, bienSoXe) {
            const message = `Bạn có chắc muốn xóa xe với biển số "${bienSoXe}"?`;
            
            if (!confirm(message)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/XeApi/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                const result = await response.json();

                if (result.success) {
                    showAlert(result.message || 'Xóa xe thành công!');
                    loadXes();
                } else {
                    showAlert(result.message || 'Có lỗi xảy ra khi xóa', 'danger');
                }
            } catch (error) {
                showAlert('Lỗi kết nối đến server', 'danger');
                console.error(error);
            }
        }

        // Event listeners
        document.getElementById('createForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const bienSoXe = document.getElementById('createBienSoXe').value.trim().toUpperCase();
            const tenXe = document.getElementById('createTenXe').value.trim();
            const maLoaiXeValue = document.getElementById('createMaLoaiXe').value;
            const maLoaiXe = parseInt(maLoaiXeValue);
            const trangThai = document.getElementById('createTrangThai').value;

            if (!bienSoXe || !tenXe || !maLoaiXeValue || isNaN(maLoaiXe) || maLoaiXe <= 0 || !trangThai) {
                showAlert('Vui lòng chọn loại xe và điền đầy đủ thông tin', 'danger');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/XeApi`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        maXe: 0,
                        bienSoXe: bienSoXe,
                        tenXe: tenXe,
                        maLoaiXe: maLoaiXe,
                        trangThai: trangThai,
                        imageURL: document.getElementById('createImageURL').value.trim() || null
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showAlert(result.message || 'Thêm xe thành công!');
                    bootstrap.Modal.getInstance(document.getElementById('createModal')).hide();
                    document.getElementById('createForm').reset();
                    document.getElementById('createImagePreview').style.display = 'none';
                    loadXes();
                } else {
                    showAlert(result.message || 'Có lỗi xảy ra', 'danger');
                }
            } catch (error) {
                showAlert('Lỗi kết nối đến server', 'danger');
                console.error(error);
            }
        });

        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = parseInt(document.getElementById('editId').value);
            const bienSoXe = document.getElementById('editBienSoXe').value.trim().toUpperCase();
            const tenXe = document.getElementById('editTenXe').value.trim();
            const maLoaiXeValue = document.getElementById('editMaLoaiXe').value;
            const maLoaiXe = parseInt(maLoaiXeValue);
            const trangThai = document.getElementById('editTrangThai').value;

            if (!bienSoXe || !tenXe || !maLoaiXeValue || isNaN(maLoaiXe) || maLoaiXe <= 0 || !trangThai) {
                showAlert('Vui lòng chọn loại xe và điền đầy đủ thông tin', 'danger');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/XeApi/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        maXe: id,
                        bienSoXe: bienSoXe,
                        tenXe: tenXe,
                        maLoaiXe: maLoaiXe,
                        trangThai: trangThai,
                        imageURL: document.getElementById('editImageURL').value.trim() || null
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showAlert(result.message || 'Cập nhật xe thành công!');
                    bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
                    document.getElementById('editForm').reset();
                    document.getElementById('editImagePreview').style.display = 'none';
                    loadXes();
                } else {
                    showAlert(result.message || 'Có lỗi xảy ra', 'danger');
                }
            } catch (error) {
                showAlert('Lỗi kết nối đến server', 'danger');
                console.error(error);
            }
        });

        document.getElementById('filterLoaiXe').addEventListener('change', filterAndDisplayXes);
        document.getElementById('filterTrangThai').addEventListener('change', filterAndDisplayXes);

        // Auto uppercase biển số
        document.getElementById('createBienSoXe').addEventListener('input', function(e) {
            e.target.value = e.target.value.toUpperCase();
        });
        document.getElementById('editBienSoXe').addEventListener('input', function(e) {
            e.target.value = e.target.value.toUpperCase();
        });

        // Hàm preview hình ảnh khi nhập URL
        function updateImagePreview(inputId, previewId, imgId) {
            const input = document.getElementById(inputId);
            const preview = document.getElementById(previewId);
            const img = document.getElementById(imgId);
            
            input.addEventListener('input', function() {
                const url = this.value.trim();
                if (url) {
                    img.src = url;
                    preview.style.display = 'block';
                    // Kiểm tra nếu ảnh không load được
                    img.onerror = function() {
                        preview.style.display = 'none';
                    };
                    img.onload = function() {
                        preview.style.display = 'block';
                    };
                } else {
                    preview.style.display = 'none';
                }
            });
        }

        // Khởi tạo preview cho form thêm và sửa
        updateImagePreview('createImageURL', 'createImagePreview', 'createPreviewImg');
        updateImagePreview('editImageURL', 'editImagePreview', 'editPreviewImg');

        // Load data khi trang được tải
        window.onload = async function() {
            await loadLoaiXes();
            await loadXes();
        };
    </script>
}