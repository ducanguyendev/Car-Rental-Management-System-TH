@{
    Layout = "_Layout";
    ViewData["Title"] = "Quản lý loại xe";
}

<style>
    .loaixe-card {
        transition: transform 0.2s, box-shadow 0.2s;
        border-radius: 10px;
    }
    .loaixe-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    }
    .loaixe-icon {
        font-size: 3rem;
        opacity: 0.8;
    }
    .table-hover tbody tr:hover {
        background-color: #f8f9fa;
        cursor: pointer;
    }
    .badge-count {
        font-size: 0.9rem;
        padding: 0.5em 0.75em;
    }
    .empty-state {
        text-align: center;
        padding: 3rem;
        color: #6c757d;
    }
    .empty-state i {
        font-size: 5rem;
        margin-bottom: 1rem;
        opacity: 0.3;
    }
</style>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-car-side"></i> Quản lý loại xe</h2>
    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createModal">
        <i class="fas fa-plus"></i> Thêm loại xe mới
    </button>
</div>

<div id="alertContainer"></div>

<!-- Cards View (Optional - for better visualization) -->
<div id="cardsView" class="row mb-4 d-none">
    <div id="cardsContainer"></div>
</div>

<!-- Table View -->
<div class="card shadow-sm">
    <div class="card-header bg-primary text-white">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-list"></i> Danh sách loại xe</h5>
            <div class="btn-group btn-group-sm" role="group">
                <button type="button" class="btn btn-light active" id="tableViewBtn">
                    <i class="fas fa-table"></i> Bảng
                </button>
                <button type="button" class="btn btn-light" id="cardsViewBtn">
                    <i class="fas fa-th-large"></i> Thẻ
                </button>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="loaiXeTable">
                <thead class="table-dark">
                    <tr>
                        <th>Mã loại</th>
                        <th>Tên loại xe</th>
                        <th>Mô tả</th>
                        <th>Số lượng xe</th>
                        <th class="text-end">Thao tác</th>
                    </tr>
                </thead>
                <tbody id="loaiXeTableBody">
                    <tr>
                        <td colspan="5" class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Đang tải...</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal Tạo mới -->
<div class="modal fade" id="createModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-plus-circle"></i> Thêm loại xe mới</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="createForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Tên loại xe <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="createTenLoaiXe" required 
                               placeholder="Ví dụ: Xe 4 chỗ, Xe 7 chỗ, Xe 16 chỗ..." />
                        <div class="invalid-feedback"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Mô tả</label>
                        <textarea class="form-control" id="createMoTa" rows="3" 
                                  placeholder="Nhập mô tả về loại xe này..."></textarea>
                        <div class="invalid-feedback"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Hủy
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-check"></i> Thêm loại xe
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Sửa -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title"><i class="fas fa-edit"></i> Chỉnh sửa loại xe</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editForm">
                <input type="hidden" id="editId" />
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Tên loại xe <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="editTenLoaiXe" required />
                        <div class="invalid-feedback"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Mô tả</label>
                        <textarea class="form-control" id="editMoTa" rows="3"></textarea>
                        <div class="invalid-feedback"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Hủy
                    </button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-save"></i> Cập nhật
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="mt-4">
    <a asp-controller="Admin" asp-action="Index" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Quay lại
    </a>
</div>

@section Scripts {
    <script>
        const API_BASE = window.location.origin;
        let currentView = 'table';

        function showAlert(message, type = 'success') {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i> ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            document.getElementById('alertContainer').innerHTML = alertHtml;
            setTimeout(() => {
                const alert = document.querySelector('#alertContainer .alert');
                if (alert) alert.remove();
            }, 5000);
        }

        async function loadLoaiXes() {
            try {
                const response = await fetch(`${API_BASE}/api/LoaiXeApi`, {
                    credentials: 'include'
                });
                const result = await response.json();

                if (result.success) {
                    const tbody = document.getElementById('loaiXeTableBody');
                    if (result.data.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="5" class="empty-state">
                                    <i class="fas fa-car-side"></i>
                                    <h5>Chưa có loại xe nào</h5>
                                    <p>Hãy thêm loại xe đầu tiên để bắt đầu!</p>
                                </td>
                            </tr>
                        `;
                    } else {
                        tbody.innerHTML = result.data.map(item => `
                            <tr>
                                <td><strong>${item.maLoaiXe}</strong></td>
                                <td>
                                    <i class="fas fa-car-side text-primary me-2"></i>
                                    <strong>${item.tenLoaiXe || ''}</strong>
                                </td>
                                <td>${item.moTa || '<span class="text-muted">Chưa có mô tả</span>'}</td>
                                <td>
                                    <span class="badge bg-info badge-count">
                                        <i class="fas fa-car"></i> ${item.soLuongXe || 0} xe
                                    </span>
                                </td>
                                <td class="text-end">
                                    <button class="btn btn-sm btn-warning me-1" onclick="editLoaiXe(${item.maLoaiXe})" title="Sửa">
                                        <i class="fas fa-edit"></i> Sửa
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteLoaiXe(${item.maLoaiXe}, '${(item.tenLoaiXe || '').replace(/'/g, "\\'")}')" title="Xóa">
                                        <i class="fas fa-trash"></i> Xóa
                                    </button>
                                </td>
                            </tr>
                        `).join('');
                    }
                    updateCardsView(result.data);
                } else {
                    showAlert(result.message || 'Có lỗi xảy ra', 'danger');
                }
            } catch (error) {
                showAlert('Lỗi kết nối đến server', 'danger');
                console.error(error);
            }
        }

        function updateCardsView(data) {
            const cardsContainer = document.getElementById('cardsContainer');
            if (data.length === 0) {
                cardsContainer.innerHTML = `
                    <div class="col-12">
                        <div class="empty-state">
                            <i class="fas fa-car-side"></i>
                            <h5>Chưa có loại xe nào</h5>
                            <p>Hãy thêm loại xe đầu tiên để bắt đầu!</p>
                        </div>
                    </div>
                `;
            } else {
                cardsContainer.innerHTML = data.map(item => `
                    <div class="col-md-4 mb-3">
                        <div class="card loaixe-card h-100 shadow-sm">
                            <div class="card-body text-center">
                                <i class="fas fa-car-side loaixe-icon text-primary mb-3"></i>
                                <h5 class="card-title">${item.tenLoaiXe || ''}</h5>
                                <p class="card-text text-muted">${item.moTa || 'Chưa có mô tả'}</p>
                                <div class="mb-3">
                                    <span class="badge bg-info badge-count">
                                        <i class="fas fa-car"></i> ${item.soLuongXe || 0} xe
                                    </span>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-warning me-1" onclick="editLoaiXe(${item.maLoaiXe})">
                                        <i class="fas fa-edit"></i> Sửa
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteLoaiXe(${item.maLoaiXe}, '${(item.tenLoaiXe || '').replace(/'/g, "\\'")}')">
                                        <i class="fas fa-trash"></i> Xóa
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        function switchView(view) {
            currentView = view;
            const tableView = document.getElementById('loaiXeTable').closest('.card');
            const cardsView = document.getElementById('cardsView');
            const tableViewBtn = document.getElementById('tableViewBtn');
            const cardsViewBtn = document.getElementById('cardsViewBtn');

            if (view === 'table') {
                tableView.classList.remove('d-none');
                cardsView.classList.add('d-none');
                tableViewBtn.classList.add('active');
                cardsViewBtn.classList.remove('active');
            } else {
                tableView.classList.add('d-none');
                cardsView.classList.remove('d-none');
                cardsViewBtn.classList.add('active');
                tableViewBtn.classList.remove('active');
            }
        }

        async function editLoaiXe(id) {
            try {
                const response = await fetch(`${API_BASE}/api/LoaiXeApi/${id}`, {
                    credentials: 'include'
                });
                const result = await response.json();

                if (result.success) {
                    document.getElementById('editId').value = result.data.maLoaiXe;
                    document.getElementById('editTenLoaiXe').value = result.data.tenLoaiXe || '';
                    document.getElementById('editMoTa').value = result.data.moTa || '';
                    new bootstrap.Modal(document.getElementById('editModal')).show();
                } else {
                    showAlert(result.message || 'Không tìm thấy loại xe', 'danger');
                }
            } catch (error) {
                showAlert('Lỗi kết nối đến server', 'danger');
                console.error(error);
            }
        }

        async function deleteLoaiXe(id, tenLoaiXe) {
            const message = tenLoaiXe 
                ? `Bạn có chắc muốn xóa loại xe "${tenLoaiXe}"?`
                : `Bạn có chắc muốn xóa loại xe này?`;
            
            if (!confirm(message + '\n\nLưu ý: Không thể xóa nếu còn có xe thuộc loại này.')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/LoaiXeApi/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                const result = await response.json();

                if (result.success) {
                    showAlert(result.message || 'Xóa loại xe thành công!');
                    loadLoaiXes();
                } else {
                    showAlert(result.message || 'Có lỗi xảy ra khi xóa', 'danger');
                }
            } catch (error) {
                showAlert('Lỗi kết nối đến server', 'danger');
                console.error(error);
            }
        }

        // Event listeners
        document.getElementById('createForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const tenLoaiXe = document.getElementById('createTenLoaiXe').value.trim();
            const moTa = document.getElementById('createMoTa').value.trim();

            if (!tenLoaiXe) {
                showAlert('Vui lòng nhập tên loại xe', 'danger');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/LoaiXeApi`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        maLoaiXe: 0,
                        tenLoaiXe: tenLoaiXe,
                        moTa: moTa || null
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showAlert(result.message || 'Thêm loại xe thành công!');
                    bootstrap.Modal.getInstance(document.getElementById('createModal')).hide();
                    document.getElementById('createForm').reset();
                    loadLoaiXes();
                } else {
                    showAlert(result.message || 'Có lỗi xảy ra', 'danger');
                }
            } catch (error) {
                showAlert('Lỗi kết nối đến server', 'danger');
                console.error(error);
            }
        });

        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = parseInt(document.getElementById('editId').value);
            const tenLoaiXe = document.getElementById('editTenLoaiXe').value.trim();
            const moTa = document.getElementById('editMoTa').value.trim();

            if (!tenLoaiXe) {
                showAlert('Vui lòng nhập tên loại xe', 'danger');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/LoaiXeApi/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        maLoaiXe: id,
                        tenLoaiXe: tenLoaiXe,
                        moTa: moTa || null
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showAlert(result.message || 'Cập nhật loại xe thành công!');
                    bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
                    document.getElementById('editForm').reset();
                    loadLoaiXes();
                } else {
                    showAlert(result.message || 'Có lỗi xảy ra', 'danger');
                }
            } catch (error) {
                showAlert('Lỗi kết nối đến server', 'danger');
                console.error(error);
            }
        });

        document.getElementById('tableViewBtn').addEventListener('click', () => switchView('table'));
        document.getElementById('cardsViewBtn').addEventListener('click', () => switchView('cards'));

        // Load danh sách khi trang được tải
        window.onload = function() {
            loadLoaiXes();
        };
    </script>
}